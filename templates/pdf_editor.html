{% extends "base.html" %}

{% block title %}PDF EditX{% endblock %}

{% block page_content %}
<link rel="stylesheet" href="{{ url_for('static', filename='pdf_editor.css') }}">
<style>
.toolbar-btn {
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #64748b;
    background-color: #4b5563;
    color: white;
    transition: all 0.2s;
    cursor: pointer;
}
.toolbar-btn:hover {
    background-color: #374151;
}
.toolbar-btn.active {
    background-color: #2563eb !important;
}
.toolbar-btn.active:hover {
    background-color: #1d4ed8 !important;
}
.pdf-page-container {
    cursor: crosshair;
}
.pdf-page-container.select-tool {
    cursor: default;
}
</style>
<!-- External libraries for PDF rendering and manipulation -->
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://unpkg.com/pdfjs-dist@3.4.120/build/pdf.min.js"></script>

<div class="w-full h-screen flex flex-col" id="pdf-editor-app">
    <!-- Header/Toolbar -->
    <div class="bg-white dark:bg-slate-800 shadow-md p-2 flex items-center justify-between z-20">
        <h1 class="text-xl font-bold text-slate-700 dark:text-slate-200 ml-4">PDF EditX</h1>
        <!-- Toolbar Controls -->
        <div id="toolbar" class="flex items-center space-x-2">
            <button class="toolbar-btn active" data-tool="select" title="Select Tool">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" />
                </svg>
            </button>
            <button class="toolbar-btn" data-tool="text" title="Add Text">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            </button>
            <button class="toolbar-btn" data-tool="draw" title="Draw (Freehand)">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                </svg>
            </button>
            <button class="toolbar-btn" data-tool="highlight" title="Highlight Text">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                </svg>
            </button>
            <div class="border-l border-slate-300 dark:border-slate-600 h-6 mx-2"></div>
            <button class="toolbar-btn" data-tool="rectangle" title="Draw Rectangle">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z" />
                </svg>
            </button>
            <button class="toolbar-btn" data-tool="circle" title="Draw Circle">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <circle cx="12" cy="12" r="10" stroke-width="2" />
                </svg>
            </button>
            <button class="toolbar-btn" data-tool="arrow" title="Draw Arrow">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                </svg>
            </button>
            <div class="border-l border-slate-300 dark:border-slate-600 h-6 mx-2"></div>
            <button class="toolbar-btn" data-tool="eraser" title="Eraser">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>
        </div>
        <div class="flex items-center space-x-3">
            <!-- Color Picker -->
            <div class="flex items-center space-x-2">
                <label class="text-sm text-slate-600 dark:text-slate-400">Color:</label>
                <input type="color" id="color-picker" value="#ff0000" class="w-8 h-8 rounded border border-slate-300 dark:border-slate-600 cursor-pointer">
            </div>
            <!-- Line Width -->
            <div class="flex items-center space-x-2">
                <label class="text-sm text-slate-600 dark:text-slate-400">Size:</label>
                <input type="range" id="line-width" min="1" max="10" value="2" class="w-16">
                <span id="line-width-value" class="text-sm text-slate-600 dark:text-slate-400 w-4">2</span>
            </div>
            <!-- Undo/Redo -->
            <button id="undo-btn" class="toolbar-btn" title="Undo">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                </svg>
            </button>
            <button id="redo-btn" class="toolbar-btn" title="Redo">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10H11a8 8 0 00-8 8v2m18-10l-6-6m6 6l-6 6" />
                </svg>
            </button>
            <button id="download-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Download PDF</button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-grow flex overflow-hidden">
        <!-- Page Thumbnails Sidebar -->
        <div id="thumbnails-panel" class="w-48 bg-slate-100 dark:bg-slate-900 p-2 overflow-y-auto">
            <!-- Thumbnails will be generated here -->
        </div>

        <!-- PDF Viewer -->
        <div id="viewer-panel" class="flex-grow bg-slate-200 dark:bg-slate-700 p-4 overflow-auto flex justify-center">
            <div id="upload-prompt" class="w-full h-full flex flex-col items-center justify-center">
                <div class="bg-white dark:bg-slate-800/50 rounded-2xl shadow-xl p-8 border border-slate-200 dark:border-slate-700 flex flex-col items-center justify-center text-center cursor-pointer hover:border-indigo-500 transition-all" onclick="document.getElementById('pdf-upload').click();">
                    <svg class="w-16 h-16 text-slate-400 dark:text-slate-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    <h3 class="text-lg font-medium text-slate-700 dark:text-slate-300">Upload a PDF to start editing</h3>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mt-2">Click here to select a PDF file</p>
                </div>
                <input type="file" id="pdf-upload" style="display: none;" accept="application/pdf">
            </div>
            <div id="pdf-viewer" class="hidden">
                <!-- Canvases for each page will be added here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
    // Wait for all libraries to load before initializing the editor
    function initializePDFEditor() {
        console.log('Checking libraries...');
        
        // Check if libraries are loaded
        if (typeof PDFLib === 'undefined') {
            console.error('PDF-lib not loaded');
            setTimeout(initializePDFEditor, 100); // Retry after 100ms
            return;
        }
        if (typeof pdfjsLib === 'undefined') {
            console.error('PDF.js not loaded');
            setTimeout(initializePDFEditor, 100); // Retry after 100ms
            return;
        }
        
        console.log('Libraries loaded successfully');
        
        // Load the simple test editor script
        const script = document.createElement('script');
        script.src = "{{ url_for('static', filename='js/pdf_editor_simple.js') }}";
        script.onload = function() {
            console.log('PDF editor script loaded successfully');
        };
        script.onerror = function() {
            console.error('Failed to load PDF editor script');
        };
        document.head.appendChild(script);
    }
    
    // Start checking when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializePDFEditor);
    } else {
        initializePDFEditor();
    }
</script>
{% endblock %}
